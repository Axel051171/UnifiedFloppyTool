name: Release

on:
  push:
    tags:
      - 'v*'

env:
  APP_NAME: UnifiedFloppyTool
  QT_VERSION: '6.6.2'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # LINUX BUILD
  # ═══════════════════════════════════════════════════════════════════════════
  build-linux:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v6
    
    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        modules: 'qtserialport'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libgl1-mesa-dev dpkg-dev fakeroot
    
    - name: Build
      run: |
        qmake UnifiedFloppyTool.pro CONFIG+=release
        make -j$(nproc)
    
    - name: Create tar.gz
      run: |
        mkdir -p dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux
        cp UnifiedFloppyTool dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux/
        cp README.md LICENSE dist/${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux/
        cd dist
        tar czf ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-linux
    
    - name: Create .deb package
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        PKG_DIR=dist/deb/${{ env.APP_NAME }}_${VERSION}_amd64
        
        mkdir -p ${PKG_DIR}/DEBIAN
        mkdir -p ${PKG_DIR}/usr/bin
        mkdir -p ${PKG_DIR}/usr/share/applications
        mkdir -p ${PKG_DIR}/usr/share/doc/${{ env.APP_NAME }}
        
        cp UnifiedFloppyTool ${PKG_DIR}/usr/bin/
        cp README.md ${PKG_DIR}/usr/share/doc/${{ env.APP_NAME }}/
        cp LICENSE ${PKG_DIR}/usr/share/doc/${{ env.APP_NAME }}/copyright
        
        cat > ${PKG_DIR}/DEBIAN/control << EOF
        Package: unifiedfloppytool
        Version: ${VERSION}
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: libqt6core6, libqt6gui6, libqt6widgets6, libqt6serialport6
        Maintainer: UFT Team <uft@example.com>
        Description: Floppy disk forensics and preservation tool
         UnifiedFloppyTool is a comprehensive tool for reading, writing,
         and analyzing floppy disk images with support for various formats
         including Commodore, Amiga, Atari, Apple, and PC.
        EOF
        
        cat > ${PKG_DIR}/usr/share/applications/unifiedfloppytool.desktop << EOF
        [Desktop Entry]
        Name=UnifiedFloppyTool
        Comment=Floppy disk forensics and preservation
        Exec=/usr/bin/UnifiedFloppyTool
        Terminal=false
        Type=Application
        Categories=Utility;System;
        EOF
        
        cd dist/deb
        fakeroot dpkg-deb --build ${{ env.APP_NAME }}_${VERSION}_amd64
        mv ${{ env.APP_NAME }}_${VERSION}_amd64.deb ../
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-release
        path: |
          dist/*.tar.gz
          dist/*.deb

  # ═══════════════════════════════════════════════════════════════════════════
  # WINDOWS BUILD (MSVC)
  # ═══════════════════════════════════════════════════════════════════════════
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6
    
    - name: Get version from tag
      id: version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtserialport'
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Build
      shell: cmd
      run: |
        qmake UnifiedFloppyTool.pro CONFIG+=release
        nmake
    
    - name: Deploy Qt
      shell: cmd
      run: |
        mkdir dist
        copy release\UnifiedFloppyTool.exe dist\
        cd dist
        windeployqt --release --no-translations UnifiedFloppyTool.exe
    
    - name: Create tar.gz
      shell: bash
      run: |
        cd dist
        tar czf ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-windows-x64.tar.gz *
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: dist/*.tar.gz

  # ═══════════════════════════════════════════════════════════════════════════
  # MACOS BUILD
  # ═══════════════════════════════════════════════════════════════════════════
  build-macos:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v6
    
    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'mac'
        target: 'desktop'
        arch: 'clang_64'
        modules: 'qtserialport'
    
    - name: Build
      run: |
        qmake UnifiedFloppyTool.pro CONFIG+=release
        make -j$(sysctl -n hw.ncpu)
    
    - name: Deploy Qt
      run: |
        macdeployqt UnifiedFloppyTool.app
    
    - name: Create tar.gz
      run: |
        mkdir -p dist
        mv UnifiedFloppyTool.app dist/
        cp README.md LICENSE dist/
        cd dist
        tar czf ${{ env.APP_NAME }}-${{ steps.version.outputs.VERSION }}-macos-x64.tar.gz UnifiedFloppyTool.app README.md LICENSE
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-release
        path: dist/*.tar.gz

  # ═══════════════════════════════════════════════════════════════════════════
  # CREATE GITHUB RELEASE
  # ═══════════════════════════════════════════════════════════════════════════
  create-release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v6
    
    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: List artifacts
      run: find artifacts -type f
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: UnifiedFloppyTool v${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/linux-release/*.tar.gz
          artifacts/linux-release/*.deb
          artifacts/windows-release/*.tar.gz
          artifacts/macos-release/*.tar.gz
