name: Build UFT

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

env:
  UFT_VERSION: "3.8.0"

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake \
            qt6-base-dev qt6-tools-dev \
            libqt6serialport6-dev \
            libgl1-mesa-dev libusb-1.0-0-dev \
            dpkg-dev fakeroot
      
      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUFT_BUILD_GUI=ON
      
      - name: Build
        run: cmake --build build --parallel $(nproc)
      
      - name: Run Tests
        run: cd build && ctest --output-on-failure
      
      - name: Create tar.gz with Qt libraries
        run: |
          mkdir -p dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/lib
          # Copy GUI executable
          if [ -f build/UnifiedFloppyTool ]; then
            cp build/UnifiedFloppyTool dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/
            
            # Copy required Qt6 libraries
            for lib in Core Gui Widgets SerialPort DBus XcbQpa; do
              libpath=$(find /usr -name "libQt6${lib}.so*" 2>/dev/null | head -1)
              if [ -n "$libpath" ]; then
                cp -L "$libpath" dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/lib/ 2>/dev/null || true
              fi
            done
            
            # Copy Qt plugins
            mkdir -p dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/plugins/platforms
            cp -r /usr/lib/x86_64-linux-gnu/qt6/plugins/platforms/libqxcb.so \
                  dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/plugins/platforms/ 2>/dev/null || true
            
            # Create launcher script
            echo '#!/bin/bash' > dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
            echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
            echo 'export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"' >> dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
            echo 'export QT_PLUGIN_PATH="$SCRIPT_DIR/plugins"' >> dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
            echo 'exec "$SCRIPT_DIR/UnifiedFloppyTool" "$@"' >> dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
            chmod +x dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/UnifiedFloppyTool.sh
          else
            echo "WARNING: GUI executable not found"
            find build -name "*.a" -o -name "*.so" 2>/dev/null | head -20
          fi
          cp README.md LICENSE dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/ 2>/dev/null || true
          echo "Run ./UnifiedFloppyTool.sh to start the application" > dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/README_LINUX.txt
          echo "If Qt libraries are missing, install: sudo apt install qt6-base-dev libusb-1.0-0" >> dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64/README_LINUX.txt
          cd dist && tar -czvf UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64.tar.gz UnifiedFloppyTool-${{ env.UFT_VERSION }}-linux-x64
      
      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp build/UnifiedFloppyTool AppDir/usr/bin/
          
          # Create desktop file
          echo '[Desktop Entry]' > AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Name=UnifiedFloppyTool' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Comment=Professional Floppy Disk Preservation Tool' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Exec=UnifiedFloppyTool' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Icon=unifiedfloppytool' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Terminal=false' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Type=Application' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          echo 'Categories=Utility;System;' >> AppDir/usr/share/applications/unifiedfloppytool.desktop
          
          # Create simple icon (placeholder)
          convert -size 256x256 xc:'#2196F3' -fill white -gravity center -pointsize 48 -annotate 0 'UFT' AppDir/usr/share/icons/hicolor/256x256/apps/unifiedfloppytool.png 2>/dev/null || \
          echo "Icon creation skipped (imagemagick not available)"
          
          # Build AppImage
          export QMAKE=/usr/lib/qt6/bin/qmake
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || true
          
          # Move to dist
          mv UnifiedFloppyTool*.AppImage dist/ 2>/dev/null || echo "AppImage creation failed, tar.gz still available"
      
      - name: Create .deb Package
        run: |
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/bin
          mkdir -p deb/usr/share/applications
          
          cp build/UnifiedFloppyTool deb/usr/bin/
          
          # Create control file
          echo 'Package: unifiedfloppytool' > deb/DEBIAN/control
          echo 'Version: ${{ env.UFT_VERSION }}' >> deb/DEBIAN/control
          echo 'Section: utils' >> deb/DEBIAN/control
          echo 'Priority: optional' >> deb/DEBIAN/control
          echo 'Architecture: amd64' >> deb/DEBIAN/control
          echo 'Depends: libqt6core6, libqt6gui6, libqt6widgets6, libusb-1.0-0' >> deb/DEBIAN/control
          echo 'Maintainer: UFT Contributors' >> deb/DEBIAN/control
          echo 'Description: Professional Floppy Disk Preservation Tool' >> deb/DEBIAN/control
          echo ' UnifiedFloppyTool (UFT) is a comprehensive floppy disk' >> deb/DEBIAN/control
          echo ' forensics and preservation tool.' >> deb/DEBIAN/control
          
          # Create desktop file
          echo '[Desktop Entry]' > deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Name=UnifiedFloppyTool' >> deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Comment=Floppy Disk Preservation Tool' >> deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Exec=/usr/bin/UnifiedFloppyTool' >> deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Terminal=false' >> deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Type=Application' >> deb/usr/share/applications/unifiedfloppytool.desktop
          echo 'Categories=Utility;' >> deb/usr/share/applications/unifiedfloppytool.desktop
          
          dpkg-deb --build deb dist/unifiedfloppytool_${{ env.UFT_VERSION }}_amd64.deb
      
      - name: Upload tar.gz
        uses: actions/upload-artifact@v4
        with:
          name: UFT-Linux-tar
          path: dist/*.tar.gz
      
      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: UFT-Linux-deb
          path: dist/*.deb
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: UFT-Linux-AppImage
          path: dist/*.AppImage
        if: always()

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.*'
          modules: 'qtserialport'
      
      - name: Configure
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUFT_BUILD_GUI=ON -DUFT_BUILD_TESTS=OFF
      
      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)
      
      - name: Deploy Qt Frameworks
        run: macdeployqt build/UnifiedFloppyTool.app -always-overwrite
      
      - name: Ad-hoc Code Sign
        run: |
          # Remove any existing signatures and re-sign with ad-hoc identity
          codesign --remove-signature build/UnifiedFloppyTool.app 2>/dev/null || true
          codesign --deep --force --sign - build/UnifiedFloppyTool.app
          # Verify the signature
          codesign --verify --deep --strict build/UnifiedFloppyTool.app
          echo "Code signing successful"
      
      - name: Create tar.gz
        run: |
          mkdir -p dist
          cd build
          tar -czvf ../dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-macos-arm64.tar.gz UnifiedFloppyTool.app
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UFT-macOS-tar
          path: dist/*.tar.gz

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.*'
          modules: 'qtserialport'
          arch: 'win64_msvc2019_64'
      
      - name: Configure
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DUFT_BUILD_GUI=ON -DUFT_BUILD_TESTS=OFF
      
      - name: Build
        run: cmake --build build --config Release --parallel
      
      - name: Deploy Qt
        shell: cmd
        run: |
          windeployqt build\Release\UnifiedFloppyTool.exe --release --no-translations
      
      - name: Create tar.gz
        shell: bash
        run: |
          mkdir -p dist
          cd build/Release
          tar -czvf ../../dist/UnifiedFloppyTool-${{ env.UFT_VERSION }}-windows-x64.tar.gz *
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UFT-Windows-tar
          path: dist/*.tar.gz

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/UFT-Linux-tar/*.tar.gz
            artifacts/UFT-Linux-deb/*.deb
            artifacts/UFT-macOS-tar/*.tar.gz
            artifacts/UFT-Windows-tar/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
