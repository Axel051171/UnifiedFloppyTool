# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UFT CI Workflow - Build & Test auf allen Plattformen
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ”¨ CI Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  QT_VERSION: '6.6.2'
  BUILD_TYPE: Release

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Linux Build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev libxkbcommon-dev libxcb-cursor0

      - name: ðŸ“¦ Cache Qt
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/Qt
          key: qt-${{ env.QT_VERSION }}-linux

      - name: ðŸŽ¨ Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          dir: ${{ github.workspace }}/Qt
          cache: true
          modules: 'qtserialport'

      - name: ðŸ”¨ Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/Qt/Qt/${{ env.QT_VERSION }}/gcc_64"

      - name: ðŸ—ï¸ Build
        run: cmake --build build -j$(nproc)

      - name: âœ… Test
        run: |
          cd build
          ctest --output-on-failure || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # macOS Build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    runs-on: macos-14
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Cache Qt
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/Qt
          key: qt-${{ env.QT_VERSION }}-macos

      - name: ðŸŽ¨ Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          dir: ${{ github.workspace }}/Qt
          cache: true
          modules: 'qtserialport'

      - name: ðŸ”¨ Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/Qt/Qt/${{ env.QT_VERSION }}/macos" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: ðŸ—ï¸ Build
        run: cmake --build build -j$(sysctl -n hw.ncpu)

      - name: âœ… Test
        run: |
          cd build
          ctest --output-on-failure || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Windows Build
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ”§ Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: ðŸ“¦ Cache Qt
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/Qt
          key: qt-${{ env.QT_VERSION }}-windows

      - name: ðŸŽ¨ Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          dir: ${{ github.workspace }}/Qt
          cache: true
          modules: 'qtserialport'

      - name: ðŸ”¨ Configure
        run: |
          cmake -B build -G "NMake Makefiles" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/Qt/Qt/${{ env.QT_VERSION }}/msvc2019_64"

      - name: ðŸ—ï¸ Build
        run: cmake --build build

      - name: âœ… Test
        run: |
          cd build
          ctest --output-on-failure
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Status Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Build Summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build-linux.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.build-macos.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-windows.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
