# UnifiedFloppyTool CI Pipeline
# Builds on Windows, macOS, and Linux
# P1-6: Improved with CTest integration

name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]
  workflow_dispatch:  # Allow manual trigger

env:
  BUILD_TYPE: Release
  QT_VERSION: '6.6.2'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Linux Build + Tests
  # ═══════════════════════════════════════════════════════════════════════════
  linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build
          sudo apt-get install -y libomp-dev libusb-1.0-0-dev
          
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DBUILD_TESTING=ON
        
      - name: Build
        run: cmake --build build --parallel
        
      - name: Run CTest
        run: |
          cd build
          ctest --output-on-failure -j4
          
      - name: Quick Executable Test
        run: |
          ./build/UnifiedFloppyTool --version || echo "GUI not built"
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UnifiedFloppyTool-Linux-x64
          path: build/UnifiedFloppyTool
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════════════════
  # Linux No-GUI Build (Faster, core libraries)
  # ═══════════════════════════════════════════════════════════════════════════
  linux-no-gui:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build
          
      - name: Configure (No GUI)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DUFT_BUILD_GUI=OFF \
            -DBUILD_TESTING=ON
        
      - name: Build
        run: cmake --build build --parallel
        
      - name: Run CTest
        run: |
          cd build
          ctest --output-on-failure -j4
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "Test Summary:"
          ctest -N | tail -5

  # ═══════════════════════════════════════════════════════════════════════════
  # macOS Build (ARM64)
  # ═══════════════════════════════════════════════════════════════════════════
  macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: brew install cmake ninja
          
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          arch: clang_64
          
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DUFT_ENABLE_OPENMP=OFF \
            -DBUILD_TESTING=ON \
            -DCMAKE_OSX_ARCHITECTURES="arm64"
        
      - name: Build
        run: cmake --build build --parallel
        
      - name: Run CTest
        run: |
          cd build
          ctest --output-on-failure -j4
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UnifiedFloppyTool-macOS-arm64
          path: build/UnifiedFloppyTool
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════════════════
  # Windows Build (MSVC)
  # ═══════════════════════════════════════════════════════════════════════════
  windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          arch: win64_msvc2019_64
          
      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_TESTING=ON
          
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
        
      - name: Run CTest
        run: |
          cd build
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure
        continue-on-error: true
        
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UnifiedFloppyTool-Windows-x64
          path: build/${{ env.BUILD_TYPE }}/UnifiedFloppyTool.exe
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════════════════
  # Windows No-GUI Build
  # ═══════════════════════════════════════════════════════════════════════════
  windows-no-gui:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
          
      - name: Configure (No GUI)
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DUFT_BUILD_GUI=OFF -DBUILD_TESTING=ON
          
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
        
      - name: Run CTest
        run: |
          cd build
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

  # ═══════════════════════════════════════════════════════════════════════════
  # Version Consistency Check
  # ═══════════════════════════════════════════════════════════════════════════
  version-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Version Consistency
        run: |
          CMAKE_VER=$(grep "VERSION" CMakeLists.txt | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "CMakeLists version: $CMAKE_VER"
          if [ -f "include/uft/uft_version.h" ]; then
            HEADER_VER=$(grep "UFT_VERSION_STRING" include/uft/uft_version.h | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
            echo "Header version: $HEADER_VER"
            if [ "$CMAKE_VER" != "$HEADER_VER" ]; then
              echo "ERROR: Version mismatch!"
              exit 1
            fi
          fi
          echo "✓ Versions consistent: $CMAKE_VER"

  # ═══════════════════════════════════════════════════════════════════════════
  # Static Analysis
  # ═══════════════════════════════════════════════════════════════════════════
  static-analysis:
    runs-on: ubuntu-22.04
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck
        
      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance \
            --error-exitcode=0 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I include -I src \
            --quiet \
            src/ 2>&1 | tee cppcheck-report.txt
          
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

  # ═══════════════════════════════════════════════════════════════════════════
  # Build Summary
  # ═══════════════════════════════════════════════════════════════════════════
  summary:
    needs: [linux, linux-no-gui, macos, windows, windows-no-gui, version-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## UFT Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | GUI | Tests | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x64 | ✓ | ✓ | ${{ needs.linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x64 | ✗ | ✓ | ${{ needs.linux-no-gui.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | ✓ | ✓ | ${{ needs.macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x64 | ✓ | ✓ | ${{ needs.windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x64 | ✗ | ✓ | ${{ needs.windows-no-gui.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Check | - | - | ${{ needs.version-check.result }} |" >> $GITHUB_STEP_SUMMARY
