name: CI Build

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

env:
  QT_VERSION: '6.6.2'
  BUILD_TYPE: Release

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Linux Build + Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-22.04
    name: ðŸ§ Linux

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libusb-1.0-0-dev \
            libudev-dev \
            libgl1-mesa-dev \
            libxcb-cursor0 \
            libxcb-xinerama0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            xvfb

      - name: ðŸŽ¨ Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtserialport'

      - name: ðŸ”¨ Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DUFT_ENABLE_SECURITY=ON \
            -DCMAKE_C_FLAGS="-Wall -Wextra" \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra"

      - name: ðŸ—ï¸ Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: âœ… Run Tests
        run: |
          cd build
          # Run tests with offscreen Qt platform (headless)
          export QT_QPA_PLATFORM=offscreen
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --timeout 120 -L "smoke|io|parser" || true

      - name: ðŸ“¦ Package (tar.gz)
        run: |
          cd build
          cpack -G TGZ || true
          ls -la *.tar.gz 2>/dev/null || echo "No tar.gz created"

      - name: ðŸ“¦ Package (DEB)
        run: |
          cd build
          cpack -G DEB || true
          ls -la *.deb 2>/dev/null || echo "No deb created"

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uft-linux-x86_64
          path: |
            build/*.tar.gz
            build/*.deb
            build/UnifiedFloppyTool
          if-no-files-found: ignore

      - name: ðŸ“Š Test Summary
        if: always()
        run: |
          echo "## Linux Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/UnifiedFloppyTool ]; then
            echo "âœ… Build: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests" >> $GITHUB_STEP_SUMMARY
          cd build && ctest -N 2>/dev/null | grep -E "Test #|Total Tests" >> $GITHUB_STEP_SUMMARY || echo "No tests found" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # macOS Build + Tests
  # Note: macOS 15 (Sequoia) required for latest Qt6 compatibility
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    runs-on: macos-15
    name: ðŸŽ macOS

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Dependencies
        run: |
          brew install cmake ninja pkg-config libusb qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "PATH=$(brew --prefix qt@6)/bin:$PATH" >> $GITHUB_ENV

      - name: ðŸ”¨ Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DUFT_ENABLE_SECURITY=ON \
            -DCMAKE_C_FLAGS="-Wall -Wextra" \
            -DCMAKE_CXX_FLAGS="-Wall -Wextra"

      - name: ðŸ—ï¸ Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: âœ… Run Tests
        run: |
          cd build
          # Run tests with offscreen Qt platform (headless CI)
          export QT_QPA_PLATFORM=offscreen
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --timeout 120 -L "smoke|io|parser" || true

      - name: ðŸ“¦ Package (tar.gz)
        run: |
          cd build
          cpack -G TGZ || true
          ls -la *.tar.gz 2>/dev/null || echo "No tar.gz created"

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uft-macos-arm64
          path: |
            build/*.tar.gz
            build/UnifiedFloppyTool.app
            build/UnifiedFloppyTool
          if-no-files-found: ignore

      - name: ðŸ“Š Test Summary
        if: always()
        run: |
          echo "## macOS Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/UnifiedFloppyTool ] || [ -d build/UnifiedFloppyTool.app ]; then
            echo "âœ… Build: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note" >> $GITHUB_STEP_SUMMARY
          echo "macOS 15 (Sequoia) may require additional signing. See docs/MACOS_BUILD.md" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Windows Build + Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-2022
    name: ðŸªŸ Windows

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: ðŸŽ¨ Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtserialport'

      - name: ðŸ”¨ Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DUFT_ENABLE_SECURITY=ON

      - name: ðŸ—ï¸ Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: âœ… Run Tests
        shell: cmd
        run: |
          cd build
          ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --timeout 120 -L "smoke|io|parser" || exit 0

      - name: ðŸ“¦ Package (ZIP)
        run: |
          cd build
          cpack -G ZIP -C ${{ env.BUILD_TYPE }}
          dir *.zip

      - name: ðŸ“¦ Deploy Qt DLLs
        run: |
          $exe = "build/Release/UnifiedFloppyTool.exe"
          if (Test-Path $exe) {
            windeployqt --release --no-translations $exe
          } else {
            Write-Host "Warning: UnifiedFloppyTool.exe not found at $exe"
            Get-ChildItem -Path build -Filter "*.exe" -Recurse | ForEach-Object { Write-Host $_.FullName }
          }

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uft-windows-x64
          path: |
            build/*.zip
            build/Release/*.exe
            build/Release/*.dll
          if-no-files-found: ignore

      - name: ðŸ“Š Test Summary
        if: always()
        shell: pwsh
        run: |
          echo "## Windows Build Results" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          echo "" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          $exe = Get-ChildItem -Path build -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            echo "âœ… Build: SUCCESS" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          } else {
            echo "âŒ Build: FAILED" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Build Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()
    name: ðŸ“Š Build Summary

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## UFT Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | ${{ needs.build-linux.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ macOS | ${{ needs.build-macos.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸªŸ Windows | ${{ needs.build-windows.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
