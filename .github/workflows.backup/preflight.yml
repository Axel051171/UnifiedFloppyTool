# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UFT Pre-Flight Checks
# LÃ¤uft VOR dem eigentlichen Build um hÃ¤ufige Fehler frÃ¼h zu erkennen
# v3.7.0: Added GUI-Only Policy Checks
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Pre-Flight Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Quick Checks (lÃ¤uft in <30 Sekunden)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preflight:
    name: "ğŸ” Pre-Flight Validation"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: "Check: Required Constants Have Includes"
        run: |
          echo "Checking for undeclared constants..."
          ERRORS=0
          
          # UFT_CRC16_INIT muss uft_mfm_flux.h inkludieren
          for f in $(grep -rl "UFT_CRC16_INIT" --include="*.c" . 2>/dev/null || true); do
            if ! grep -q "uft_mfm_flux.h" "$f"; then
              echo "âŒ $f uses UFT_CRC16_INIT but missing uft_mfm_flux.h"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          # atomic_int/atomic_bool muss uft_atomics.h inkludieren
          for f in $(grep -rl "atomic_int\|atomic_bool" --include="*.c" . 2>/dev/null || true); do
            if ! grep -q "uft_atomics.h\|stdatomic.h" "$f"; then
              echo "âŒ $f uses atomics but missing uft_atomics.h"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::$ERRORS files missing required includes"
            exit 1
          fi
          echo "âœ… All constants have required includes"

      - name: "Check: Struct Member Definitions"
        run: |
          echo "Checking struct member definitions..."
          
          # uft_prot_scheme_t muss diese Members haben
          if ! grep -q "id;" include/uft/uft_protection.h; then
            echo "::error::uft_prot_scheme_t missing 'id' member"
            exit 1
          fi
          
          # uft_md_session muss stats Member haben  
          if grep -q "uft_md_session" include/uft/*.h && ! grep -A20 "uft_md_session" include/uft/*.h | grep -q "stats"; then
            echo "::error::uft_md_session missing 'stats' member"
            exit 1
          fi
          echo "âœ… All struct members defined"

      - name: "Check: Include Guards"
        run: |
          echo "Checking include guards..."
          MISSING=0
          
          # PrÃ¼fe alle .h Dateien auf Include Guards (#ifndef oder #pragma once)
          for h in $(find include -name "*.h" 2>/dev/null); do
            if ! head -20 "$h" | grep -qE "#ifndef|#pragma once"; then
              echo "âš ï¸ $h: No include guard found"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 500 ]; then
            echo "::error::Too many headers ($MISSING) without include guards"
            exit 1
          elif [ $MISSING -gt 50 ]; then
            echo "::warning::$MISSING headers without include guards (technical debt)"
          fi
          echo "âœ… Include guards check complete ($MISSING warnings)"

      - name: "Check: CMakeLists.txt Syntax"
        run: |
          echo "Checking CMakeLists.txt files..."
          ERRORS=0
          
          for cmake in $(find . -name "CMakeLists.txt" 2>/dev/null); do
            # PrÃ¼fe auf offensichtliche Syntaxfehler
            if grep -qE "^\s*(if|else|endif|foreach|endforeach|function|endfunction|macro|endmacro)\s*[^(]" "$cmake"; then
              echo "âŒ $cmake: Possible syntax error"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::CMake syntax errors found"
            exit 1
          fi
          echo "âœ… CMakeLists.txt syntax OK"

      - name: "Check: P0 GUI Blockers (Informational)"
        run: |
          echo "Checking P0 GUI blockers..."
          
          if [ -f "TODO.md" ]; then
            P0_COUNT=$(grep -c "P0-GUI.*\[BLOCKER\]" TODO.md 2>/dev/null || echo "0")
            
            if [ "$P0_COUNT" -gt 0 ]; then
              echo "::warning::$P0_COUNT P0 GUI blockers found - see TODO.md"
              echo ""
              echo "P0 Blockers:"
              grep "^### P0-GUI" TODO.md | head -10
            else
              echo "âœ… No P0 blockers"
            fi
          fi

      - name: "Check: Simulated Code (Informational)"
        run: |
          echo "Checking for simulated/fake code in GUI..."
          
          SIMULATE=$(grep -rn "// Simulate\|// For now:" src/*.cpp 2>/dev/null | wc -l || echo "0")
          FAKE=$(grep -rn "Hardcoded\|hardcoded\|fake result" src/*.cpp 2>/dev/null | wc -l || echo "0")
          
          TOTAL=$((SIMULATE + FAKE))
          
          if [ "$TOTAL" -gt 0 ]; then
            echo "::warning::Found $TOTAL simulated/fake code blocks in GUI"
            echo ""
            echo "Locations:"
            grep -rn "// Simulate\|// For now:\|Hardcoded" src/*.cpp 2>/dev/null | head -10 || true
          else
            echo "âœ… No simulated code found"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Header Consistency Check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  header-check:
    name: "ğŸ“‹ Header Consistency"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: "Check: Type Definition Consistency"
        run: |
          echo "Checking type definition consistency..."
          
          # PrÃ¼fe ob wichtige Types in core header definiert sind
          TYPES="uft_rc_t uft_error_t uft_platform_t uft_disk_unified_t"
          
          for t in $TYPES; do
            if ! grep -rq "typedef.*$t\|enum.*$t" include/uft/core/ include/uft/; then
              echo "âš ï¸ Type $t not found in headers"
            fi
          done
          echo "âœ… Type definitions checked"

      - name: "Check: Error Code Consistency"  
        run: |
          echo "Checking error codes..."
          
          # Wichtige Error-Codes mÃ¼ssen definiert sein
          ERRORS="UFT_OK UFT_ERR_NOMEM UFT_ERR_INVALID UFT_ERR_IO"
          
          for err in $ERRORS; do
            if ! grep -rq "#define $err\|$err.*=" include/uft/uft_error*.h; then
              echo "::error::Missing error code: $err"
              exit 1
            fi
          done
          echo "âœ… All required error codes defined"

      - name: "Check: GUI Backend Calls (Informational)"
        run: |
          echo "Checking GUI backend integration..."
          
          UFT_CALLS=$(grep -roh "uft_[a-z_]*(" src/*.cpp 2>/dev/null | sort | uniq -c | sort -rn | head -10)
          CALL_COUNT=$(grep -roh "uft_[a-z_]*(" src/*.cpp 2>/dev/null | wc -l || echo "0")
          
          echo "Total uft_* calls in GUI: $CALL_COUNT"
          
          if [ "$CALL_COUNT" -lt 10 ]; then
            echo "::warning::GUI has very few backend calls ($CALL_COUNT) - integration incomplete"
          fi
          
          echo ""
          echo "Top uft_* calls:"
          echo "$UFT_CALLS"
