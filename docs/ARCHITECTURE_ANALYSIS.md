# UnifiedFloppyTool - Architektur-Analyse

**Erstellt:** Januar 2025  
**Status:** Deep-Dive Analyse  
**Projekt-GrÃ¶ÃŸe:** ~64,000 Zeilen (25,842 C + 38,313 H)

---

## 1. ZENTRALE DATENMODELLE

### 1.1 Hierarchie der Datenstrukturen

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA MODEL HIERARCHY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ImageContainer                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                     uft_disk_t (Core)                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ path, format, flags                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ geometry (uft_geometry_t)                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ read_only, modified                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ plugin_data (format-spezifisch)                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ track_cache[]                                                â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                  â”‚                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                     flux_disk_t (Flux)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ max_cylinders, max_heads                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ tracks[] (flux_track_t**)                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ format (DISK_FORMAT_*)                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ total_size_bytes, overall_quality                            â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                              Track                                     â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚  â”‚   uft_track_t (Core)     â”‚    â”‚   flux_track_t (Flux)        â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ cylinder, head        â”‚    â”‚  â€¢ cylinder, head            â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ sectors[]             â”‚    â”‚  â€¢ flux_samples[]            â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ flux[] (optional)     â”‚    â”‚  â€¢ bitstream                 â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ raw_data[]            â”‚    â”‚  â€¢ quality_score             â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ encoding              â”‚    â”‚  â€¢ encoding                  â”‚    â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ metrics               â”‚    â”‚  â€¢ num_revolutions           â”‚    â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                      â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                              Sector                                    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚     â”‚
â”‚  â”‚  â”‚                      uft_sector_t                                 â”‚â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ id (uft_sector_id_t: C/H/R/N, CRC)                            â”‚â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ data[], data_size                                             â”‚â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ data_crc, status (Flags)                                      â”‚â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ bit_position, gap_before (Timing)                             â”‚â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                      â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                           FluxStream                                   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚  flux_bitstream_t       â”‚    â”‚   Raw Flux (in Track)           â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ bits[]               â”‚    â”‚  â€¢ uint32_t* flux               â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ bit_count            â”‚    â”‚  â€¢ flux_count                   â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ encoding             â”‚    â”‚  â€¢ flux_tick_ns                 â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ sync_patterns_found  â”‚    â”‚                                 â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ decode_errors        â”‚    â”‚                                 â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Datenmodell-Probleme

| Problem | Beschreibung | Schweregrad |
|---------|--------------|-------------|
| **Duale Disk-Strukturen** | `uft_disk_t` vs `flux_disk_t` - keine einheitliche Abstraktion | ğŸ”´ Hoch |
| **Track-Redundanz** | `uft_track_t.flux[]` UND `flux_track_t.flux_samples[]` | ğŸŸ¡ Mittel |
| **Fehlende FluxStream-Kapselung** | Flux-Daten direkt in Track, nicht als eigenstÃ¤ndiges Objekt | ğŸŸ¡ Mittel |
| **plugin_data void*** | Keine Typsicherheit fÃ¼r Format-spezifische Daten | ğŸŸ¡ Mittel |

---

## 2. SCHICHTEN-ARCHITEKTUR (IST-ZUSTAND)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CURRENT LAYERS                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                              GUI LAYER                                  â”‚   â”‚
â”‚   â”‚  gui/forms/mainwindow.ui                                               â”‚   â”‚
â”‚   â”‚  include/uft/gui/*.h (uft_format_info_widget.h)                        â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  âš ï¸ PROBLEM: Business Logic in GUI Header (decode/parse functions)     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                         â”‚
â”‚                                      â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                            CORE LAYER                                   â”‚   â”‚
â”‚   â”‚  src/core/uft_core.c (856 Zeilen)                                      â”‚   â”‚
â”‚   â”‚  src/core/uft_format_plugin.c                                          â”‚   â”‚
â”‚   â”‚  src/core/uft_cache.c                                                  â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  âš ï¸ PROBLEM: MFM/GCR Decoder in Core (sollte in decoders/)             â”‚   â”‚
â”‚   â”‚  âš ï¸ PROBLEM: flux_core.c in core/ (Schichten-Vermischung)              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                           â”‚                          â”‚              â”‚
â”‚          â–¼                           â–¼                          â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  FORMATS     â”‚    â”‚     DECODERS         â”‚    â”‚    HARDWARE        â”‚       â”‚
â”‚   â”‚  26 Plugins  â”‚    â”‚  src/decoders/       â”‚    â”‚  src/hardware/     â”‚       â”‚
â”‚   â”‚              â”‚    â”‚  + src/core/uft_mfm* â”‚    â”‚                    â”‚       â”‚
â”‚   â”‚  âœ… Sauber   â”‚    â”‚  âš ï¸ Fragmentiert    â”‚    â”‚  âœ… Sauber         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 Grenzprobleme

#### âœ… SAUBER GETRENNT:
- **Hardware â†” Formats**: Keine direkten Aufrufe
- **Hardware â†” Core**: Klare uft_hw_* API
- **Core â†” Formats**: Plugin-System funktioniert

#### âš ï¸ VERMISCHT:
| Wo | Was | Problem |
|----|-----|---------|
| `src/core/uft_mfm_*.c` | MFM Encoder/Decoder | GehÃ¶rt nach `src/decoders/` |
| `src/core/flux_core.c` | Flux-Handling | GehÃ¶rt nach `src/flux/` |
| `src/core/uft_pll.c` | PLL-Logik | GehÃ¶rt nach `src/decoders/` |
| `include/uft/gui/uft_format_info_widget.h` | Parsing-Code | GehÃ¶rt nach Core |
| `src/uft_gui_params_extended.c` | Im Root statt gui/ | Falsche Location |

---

## 3. GOD-MODULE ANALYSE

### 3.1 Kandidaten fÃ¼r Splitting

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           GOD-MODULE REPORT                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                               â•‘
â•‘  ğŸ”´ KRITISCH (>1000 Zeilen, >30 Funktionen, Multiple Responsibilities)       â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘
â•‘                                                                               â•‘
â•‘  1. uft_forensic_imaging.c (1129 Zeilen, 32 Funktionen)                      â•‘
â•‘     â”œâ”€â”€ CPU Capabilities Detection                                           â•‘
â•‘     â”œâ”€â”€ SIMD find_nonzero (C/SSE2/AVX2)                                     â•‘
â•‘     â”œâ”€â”€ File I/O Helpers                                                     â•‘
â•‘     â”œâ”€â”€ Job Management                                                       â•‘
â•‘     â”œâ”€â”€ Hashing (MD5/SHA256)                                                â•‘
â•‘     â”œâ”€â”€ Split-File Handling                                                  â•‘
â•‘     â”œâ”€â”€ Bad Sector Tracking                                                  â•‘
â•‘     â””â”€â”€ Execution Engine                                                     â•‘
â•‘                                                                               â•‘
â•‘     SPLIT INTO:                                                              â•‘
â•‘     â€¢ uft_fi_cpu.c       (CPU Detection)                                     â•‘
â•‘     â€¢ uft_fi_simd.c      (SIMD find_nonzero)                                 â•‘
â•‘     â€¢ uft_fi_job.c       (Job Management)                                    â•‘
â•‘     â€¢ uft_fi_hash.c      (Hashing)                                           â•‘
â•‘     â€¢ uft_fi_split.c     (Split Files)                                       â•‘
â•‘     â€¢ uft_fi_exec.c      (Execution)                                         â•‘
â•‘                                                                               â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
â•‘                                                                               â•‘
â•‘  2. uft_gui_params_extended.h (631 Zeilen)                                   â•‘
â•‘     15 typedef structs + 4 enums - "Kitchen Sink" Header                     â•‘
â•‘                                                                               â•‘
â•‘     SPLIT INTO:                                                              â•‘
â•‘     â€¢ uft_gui_geometry.h     (Geometry Settings)                             â•‘
â•‘     â€¢ uft_gui_timing.h       (MFM Timing)                                    â•‘
â•‘     â€¢ uft_gui_processing.h   (Adaptive Processing)                           â•‘
â•‘     â€¢ uft_gui_forensics.h    (Forensic Settings)                             â•‘
â•‘                                                                               â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
â•‘                                                                               â•‘
â•‘  3. uft_format_variants.h (829 Zeilen)                                       â•‘
â•‘     EnthÃ¤lt ALLE Format-Varianten als Inline-Daten                           â•‘
â•‘                                                                               â•‘
â•‘     REFACTOR:                                                                â•‘
â•‘     â€¢ Varianten als separate .c mit externen Tabellen                        â•‘
â•‘     â€¢ Lazy-Loading statt statischer Arrays                                   â•‘
â•‘                                                                               â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
â•‘                                                                               â•‘
â•‘  ğŸŸ¡ BEOBACHTEN (500-1000 Zeilen, Multiple Concerns)                          â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â•‘
â•‘                                                                               â•‘
â•‘  4. uft_fm_decoder.c (944 Zeilen)                                            â•‘
â•‘     FM Decoding + CRC + Sector Extraction - Akzeptabel als Decoder-Unit      â•‘
â•‘                                                                               â•‘
â•‘  5. uft_core.c (856 Zeilen, 33 Funktionen)                                   â•‘
â•‘     Disk/Track/Sector Operations + Init + Conversion - Am Limit              â•‘
â•‘     Candidate Split: uft_convert.c herauslÃ¶sen                               â•‘
â•‘                                                                               â•‘
â•‘  6. uft_hw_greaseweazle.c (705 Zeilen)                                       â•‘
â•‘     Alles GW-spezifisch - OK fÃ¼r einzelnen Hardware-Driver                   â•‘
â•‘                                                                               â•‘
â•‘  7. uft_hardware.c (704 Zeilen)                                              â•‘
â•‘     Backend Registration + High-Level API - OK fÃ¼r Facade                    â•‘
â•‘                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 4. EMPFOHLENE ZIEL-ARCHITEKTUR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TARGET ARCHITECTURE                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                              GUI LAYER                                  â”‚   â”‚
â”‚   â”‚  â€¢ Qt Widgets / QML                                                    â”‚   â”‚
â”‚   â”‚  â€¢ ViewModels (Adapter zum Core)                                       â”‚   â”‚
â”‚   â”‚  â€¢ KEINE Business Logic                                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         APPLICATION LAYER                               â”‚   â”‚
â”‚   â”‚  â€¢ Use Cases (ReadDisk, WriteDisk, Convert, Analyze)                   â”‚   â”‚
â”‚   â”‚  â€¢ Workflow Orchestration                                              â”‚   â”‚
â”‚   â”‚  â€¢ Progress Reporting                                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                           DOMAIN LAYER                                  â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚   Disk      â”‚  â”‚   Track     â”‚  â”‚   Sector    â”‚  â”‚   Flux      â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  (Entity)   â”‚  â”‚  (Entity)   â”‚  â”‚  (Entity)   â”‚  â”‚  (Stream)   â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚                    Unified Image Container                       â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Kombiniert uft_disk_t + flux_disk_t                          â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Einheitlicher Zugriff auf Sektor- und Flux-Daten             â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                       INFRASTRUCTURE LAYER                              â”‚   â”‚
â”‚   â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚       â–¼               â–¼                       â–¼               â–¼        â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚ Formats â”‚    â”‚Decoders â”‚           â”‚  Hardware   â”‚   â”‚  Utils  â”‚   â”‚   â”‚
â”‚   â”‚  â”‚ 26      â”‚    â”‚ MFM/FM  â”‚           â”‚  Adapters   â”‚   â”‚  CRC    â”‚   â”‚   â”‚
â”‚   â”‚  â”‚ Plugins â”‚    â”‚ GCR     â”‚           â”‚  GW/KF/FC   â”‚   â”‚  SIMD   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚         â”‚    â”‚ PLL     â”‚           â”‚  SC/OCM     â”‚   â”‚  Hash   â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. REFACTORING-PLAN

### Phase 1: God-Module aufbrechen (1-2 Wochen)

```bash
# 1. Forensic Imaging aufteilen
src/forensic/
â”œâ”€â”€ uft_fi_cpu.c         # CPU Detection
â”œâ”€â”€ uft_fi_simd.c        # SIMD Operations  
â”œâ”€â”€ uft_fi_job.c         # Job Management
â”œâ”€â”€ uft_fi_hash.c        # Hashing
â”œâ”€â”€ uft_fi_split.c       # Split Files
â”œâ”€â”€ uft_fi_exec.c        # Execution Engine
â””â”€â”€ uft_forensic.h       # Unified Header

# 2. GUI Params aufteilen
include/uft/gui/
â”œâ”€â”€ uft_gui_geometry.h
â”œâ”€â”€ uft_gui_timing.h
â”œâ”€â”€ uft_gui_processing.h
â””â”€â”€ uft_gui_forensics.h
```

### Phase 2: Decoder konsolidieren (1 Woche)

```bash
# Alle Decoder an einem Ort
src/decoders/
â”œâ”€â”€ mfm/
â”‚   â”œâ”€â”€ uft_mfm_decoder.c
â”‚   â”œâ”€â”€ uft_mfm_avx2.c
â”‚   â”œâ”€â”€ uft_mfm_sse2.c
â”‚   â””â”€â”€ uft_mfm_scalar.c
â”œâ”€â”€ fm/
â”‚   â””â”€â”€ uft_fm_decoder.c
â”œâ”€â”€ gcr/
â”‚   â””â”€â”€ uft_gcr_decoder.c
â”œâ”€â”€ pll/
â”‚   â”œâ”€â”€ uft_pll.c
â”‚   â””â”€â”€ uft_dpll_wd1772.c
â””â”€â”€ uft_decoder_plugin.c
```

### Phase 3: Unified Image Container (2-3 Wochen)

```c
// NEU: Einheitlicher Container
typedef struct uft_image {
    // Basis-Info
    char*               path;
    uft_format_t        format;
    uft_geometry_t      geometry;
    
    // Sektor-Ebene (decoded)
    uft_track_t**       tracks;
    size_t              track_count;
    
    // Flux-Ebene (raw)  
    uft_flux_stream_t** flux_streams;  // Optional
    size_t              flux_count;
    
    // Plugin
    const uft_format_plugin_t* plugin;
    void*               plugin_data;
    
    // State
    uint32_t            flags;
    bool                modified;
} uft_image_t;
```

### Phase 4: Layer Cleanup (1 Woche)

1. `flux_core.c` â†’ `src/flux/`
2. Business Logic aus GUI-Headers entfernen
3. `uft_gui_params_extended.c` â†’ `src/gui/`

---

## 6. METRIKEN (Vorher/Nachher)

| Metrik | Vorher | Nachher (Ziel) |
|--------|--------|----------------|
| Max. Datei-GrÃ¶ÃŸe | 1129 Zeilen | <500 Zeilen |
| Max. Funktionen/Datei | 33 | <20 |
| ZirkulÃ¤re Deps | 2 | 0 |
| Layer Violations | 5 | 0 |
| Duale Datenmodelle | 2 | 1 (Unified) |
| Coverage God-Modules | 0% | >80% |

---

## 7. NÃ„CHSTE SCHRITTE

1. **Sofort**: God-Module dokumentieren (TODOs einfÃ¼gen)
2. **Woche 1**: `uft_forensic_imaging.c` aufteilen
3. **Woche 2**: Decoder konsolidieren
4. **Woche 3-4**: Unified Image Container implementieren
5. **Woche 5**: Layer Cleanup + Tests

---

*Analyse erstellt mit Claude - Januar 2025*
